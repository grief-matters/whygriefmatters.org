---
import {
  internetResourceCollectionKeys,
  type InternetResourceCollectionKey,
  type InternetResourceEntries,
} from "@content/collections";
import type { PopulationSlug } from "@content/model/population";
import { getAllDescendantCategoryIds } from "@content/utils";
import PageHeaderLayout from "@ui/layouts/PageHeaderLayout.astro";
import SitePageLayout from "@ui/layouts/SitePageLayout.astro";
import Button from "@ui/base/Button.astro";
import Container from "@ui/base/Container.astro";
import LayoutSurface from "@ui/base/LayoutSurface.astro";
import PortableTextContentBlock from "@ui/base/PortableTextContentBlock.astro";
import Typography from "@ui/base/Typography.astro";
import ResourceListingsOrchestrator from "@ui/scripted/resource-listings-controller/ResourceListingsOrchestrator.astro";
import { getCollection, type CollectionEntry } from "astro:content";

interface Props {
  categoryEntry: CollectionEntry<"categories">;
  populationEntry: CollectionEntry<"populations">;
  internetResources: InternetResourceEntries;
  resourceTypes: Array<InternetResourceCollectionKey>;
}

const labelMakerFnMap: Record<PopulationSlug, (name: string) => Array<string>> =
  {
    "latino-and-hispanic-americans": (name: string) => ["Resources for", name],
    "african-american-black": (name: string) => ["Resources for", name],
    "asian-american-and-pacific-islander": (name: string) => [
      "Resources for",
      name,
    ],
    "people-with-disabilities": (name: string) => ["Resources for", name],
    "lgbtq-community": (name: string) => ["Resources for the", name],
    "indigenous-communities": (name: string) => ["Resources for", name],
  };

export async function getStaticPaths() {
  const categoryEntries = await getCollection("categories");
  const populationEntries = await getCollection("populations");

  // Pre-fetch all resource collections once (instead of per category x population)
  const allResources = new Map<
    InternetResourceCollectionKey,
    Array<CollectionEntry<InternetResourceCollectionKey>>
  >();
  for (const key of internetResourceCollectionKeys) {
    allResources.set(key, await getCollection(key));
  }

  // Pre-compute descendant category IDs for all categories
  const descendantMap = new Map<string, Set<string>>();
  for (const categoryEntry of categoryEntries) {
    descendantMap.set(
      categoryEntry.id,
      getAllDescendantCategoryIds(categoryEntry.id, categoryEntries),
    );
  }

  const staticPaths = [];

  for (const categoryEntry of categoryEntries) {
    const allCategoryIds = descendantMap.get(categoryEntry.id)!;

    for (const populationEntry of populationEntries) {
      const internetResources: InternetResourceEntries = {};
      for (const key of internetResourceCollectionKeys) {
        const resourcesForKey = allResources
          .get(key)!
          .filter(
            ({ data }) =>
              data.categories.some((c) => allCategoryIds.has(c.id)) &&
              data.populations.some((p) => p.id === populationEntry.id),
          );

        if (resourcesForKey.length > 0) {
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          (internetResources as any)[key] = resourcesForKey;
        }
      }

      if (Object.values(internetResources).flat().length === 0) {
        continue;
      }

      const resourceTypes = Object.keys(internetResources);

      staticPaths.push({
        params: {
          category: categoryEntry.data.slug,
          population: populationEntry.data.slug,
        },
        props: {
          categoryEntry,
          populationEntry,
          internetResources,
          resourceTypes,
        },
      });
    }
  }

  return staticPaths;
}

const { categoryEntry, populationEntry, internetResources, resourceTypes } = Astro.props;

const labelMaker = labelMakerFnMap[populationEntry.data.slug];
const labelParts = labelMaker(populationEntry.data.name);
---

<SitePageLayout>
  <PageHeaderLayout
    surfaceVariant="primaryContrast"
    surfaceVariantKey={1}
    image={populationEntry.data.image}
  >
    <div class="md:h-full md:flex md:flex-col">
      <div class="md:h-full md:flex md:items-center">
        <div class="px-8 py-12 md:flex md:items-center md:justify-end md:grow">
          <div class="basis-100">
            <Typography
              marginBottom={2}
              as="h1"
              variant="title-1"
              colorVariant="primaryContrast"
            >
              {
                categoryEntry.data.displayTitle ??
                  categoryEntry.data.title
              }
            </Typography>
            {
              categoryEntry.data.shortDescription && (
                <Typography
                  as="p"
                  variant="body-2"
                  colorVariant="primaryContrast"
                  marginBottom={2}
                >
                  {categoryEntry.data.shortDescription}
                </Typography>
              )
            }
          </div>
        </div>
      </div>
      <LayoutSurface variant="tertiary" variantKey={3}>
        <div class="px-8 py-6 md:flex md:items-center md:justify-end">
          <div class="basis-100">
            <p class="mb-3">
              <Typography as="span" variant="body-2" class="block">
                <span class="italic">
                  {`${labelParts[0]} `}
                </span>
              </Typography>
              <Typography as="span" variant="title-2">
                {labelParts[1]}
              </Typography>
            </p>
            <Button
              as="a"
              colorVariant="primaryContrast"
              href={`/${categoryEntry.data.slug}`}
              class="inline-block"
            >
              <Typography as="span" colorVariant="primaryContrast">
                {"See all resources for this topic"}
              </Typography>
            </Button>
          </div>
        </div>
      </LayoutSurface>
    </div>
  </PageHeaderLayout>
  {/* Category Description */}
  {
    categoryEntry.data.description && (
      <LayoutSurface paddingY={6}>
        <Container paddingX={4}>
          <PortableTextContentBlock
            textVariant="prominent-first"
            textAlign="center"
            portableText={categoryEntry.data.description}
          />
        </Container>
      </LayoutSurface>
    )
  }

  <LayoutSurface as="section" paddingX={2} paddingY={5}>
    <ResourceListingsOrchestrator
      internetResources={internetResources}
      resourceTypes={resourceTypes}
    />
  </LayoutSurface>
</SitePageLayout>
