---
import {
  getCollection,
  getEntries,
  type CollectionEntry,
  type ReferenceDataEntry,
} from "astro:content";

import {
  internetResourceCollectionKeys,
  type InternetResourceCollectionKey,
  type InternetResourceEntries,
} from "@content/collections";

import { getAllDescendantCategoryIds } from "@ui/utils/content/category";

import Section from "@ui/layouts/Section.astro";
import Slide from "@ui/layouts/slider/Slide.astro";
import Slider from "@ui/layouts/slider/Slider.astro";
import SitePageLayout from "@ui/layouts/SitePageLayout.astro";

import Container from "@ui/base/Container.astro";
import LayoutSurface from "@ui/base/LayoutSurface.astro";
import Typography from "@ui/base/Typography.astro";

import CategoryDescription from "@ui/composite/content-linked/category/CategoryDescription.astro";
import CategoryPageHeader from "@ui/composite/content-linked/category/CategoryPageHeader.astro";
import CategoryPopulationsNavigator from "@ui/composite/content-linked/category/CategoryPopulationsNavigator.astro";
import FeaturedResourceRenderer from "@ui/composite/content-linked/internet-resources/FeaturedResourceRenderer.astro";

import ResourceListingsOrchestrator from "@ui/scripted/resource-listings-controller/ResourceListingsOrchestrator.astro";

interface Props {
  categoryEntry: CollectionEntry<"categories">;
  internetResources: InternetResourceEntries;
  populations: Array<CollectionEntry<"populations">>;
  resourceTypes: Array<InternetResourceCollectionKey>;
  parentCategory?: CollectionEntry<"categories">;
}

export async function getStaticPaths() {
  const categoryEntries = await getCollection("categories");

  // Pre-fetch all resource collections once (instead of per category)
  const allResources = new Map<
    InternetResourceCollectionKey,
    Array<CollectionEntry<InternetResourceCollectionKey>>
  >();
  for (const key of internetResourceCollectionKeys) {
    allResources.set(key, await getCollection(key));
  }

  // Pre-compute descendant category IDs for all categories
  const descendantMap = new Map<string, Set<string>>();
  for (const categoryEntry of categoryEntries) {
    descendantMap.set(
      categoryEntry.id,
      getAllDescendantCategoryIds(categoryEntry.id, categoryEntries),
    );
  }

  const staticPaths = [];

  for (const categoryEntry of categoryEntries) {
    const parentCategory = categoryEntries.find((entry) =>
      entry.data.subcategories.map((c) => c.id).includes(categoryEntry.id),
    );

    const allCategoryIds = descendantMap.get(categoryEntry.id)!;

    const internetResources: InternetResourceEntries = {};
    const populationMap: Record<
      string,
      ReferenceDataEntry<"populations", string>
    > = {};

    for (const key of internetResourceCollectionKeys) {
      const resourcesForKey = allResources
        .get(key)!
        .filter(({ data }) =>
          data.categories.some((c) => allCategoryIds.has(c.id)),
        );

      resourcesForKey.forEach((r) =>
        r.data.populations.forEach((p) => (populationMap[p.id] = p)),
      );

      if (resourcesForKey.length > 0) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        (internetResources as any)[key] = resourcesForKey;
      }
    }

    const populations = await getEntries(Object.values(populationMap));

    const resourceTypes = Object.keys(internetResources);

    staticPaths.push({
      params: {
        category: categoryEntry.data.slug,
      },
      props: {
        categoryEntry,
        internetResources,
        resourceTypes,
        populations,
        parentCategory,
      },
    });
  }

  return staticPaths;
}

const props = Astro.props;
---

<SitePageLayout>
  <CategoryPageHeader
    categoryEntryData={props.categoryEntry.data}
    parentCategory={props.parentCategory}
  />

  {/* Category Description */}
  {
    props.categoryEntry.data.description && (
      <Section>
        <CategoryDescription
          description={props.categoryEntry.data.description}
        />
      </Section>
    )
  }

  {/* Underserved Populations */}
  {
    props.populations.length > 0 && (
      <LayoutSurface paddingX={2} paddingY={4}>
        <Container>
          <CategoryPopulationsNavigator
            category={props.categoryEntry}
            populations={props.populations}
          />
        </Container>
      </LayoutSurface>
    )
  }

  {/* Featured Resources */}
  {
    (props.categoryEntry.data.featuredResources ?? []).length > 0 && (
      <LayoutSurface paddingY={6} colorVariantKey={4}>
        <Container>
          <Typography
            textAlign="center"
            marginBottom={2}
            as="h2"
            variant="title-2"
            set:text="Featured Resources"
          />
        </Container>
        <Slider>
          {props.categoryEntry.data.featuredResources.map((resource) => (
            <Slide paddingX={1} paddingY={4}>
              <FeaturedResourceRenderer
                fullHeight
                resourceRef={resource.refId}
                resourceType={resource.refType}
              />
            </Slide>
          ))}
        </Slider>
      </LayoutSurface>
    )
  }

  <LayoutSurface as="section" paddingX={2} paddingY={5}>
    <ResourceListingsOrchestrator
      internetResources={props.internetResources}
      resourceTypes={props.resourceTypes}
    />
  </LayoutSurface>
</SitePageLayout>
