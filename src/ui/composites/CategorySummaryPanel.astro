---
import Typography from "@ui/primitives/Typography.astro";
import { getEntry } from "astro:content";
import CategoryResourceTypesSummary from "./CategoryResourceTypesSummary.astro";
import {
  getResourceTypeCountsForCategory,
  getResourceTypeCountsForCategoryAndPopulation,
  buildResourceExistenceSet,
} from "@ui/orchestrators/nav-utils";
import type { ColorVariant } from "@ui/utils/styles";
import { getEntries, getCollection } from "astro:content";
import { getAllDescendantCategoryIds } from "@content/utils";
import ButtonLink from "@ui/primitives/ButtonLink.astro";
import Stack from "@ui/primitives/Stack.astro";
import Link from "@ui/primitives/Link.astro";

interface Props {
  categoryId: string;
  colorVariant?: ColorVariant;
  populationId?: string;
  populationSlug?: string;
}

const { colorVariant = "neutral", populationId, populationSlug, ...props } = Astro.props;

const categoryEntry = await getEntry("categories", props.categoryId);
if (!categoryEntry) {
  throw new Error(`Could not get category with id: ${props.categoryId}`);
}

const refs = categoryEntry.data.subcategories.map(({ collection, id }) => ({
  collection,
  id,
}));
let subCategoryEntries = await getEntries(refs);

// When filtering by population, prune subcategories that have no resources for this population
if (populationId) {
  const existenceSet = await buildResourceExistenceSet();
  const allCategories = await getCollection("categories");
  subCategoryEntries = subCategoryEntries.filter((sub) => {
    const descendantIds = getAllDescendantCategoryIds(sub.id, allCategories);
    return Array.from(descendantIds).some((catId) =>
      existenceSet.has(`${catId}:${populationId}`),
    );
  });
}

const resourceTypeCounts = populationId
  ? await getResourceTypeCountsForCategoryAndPopulation(props.categoryId, populationId)
  : await getResourceTypeCountsForCategory(props.categoryId);
---

<Stack spacing={3}>
  <Typography variant="title-3" set:text={categoryEntry.data.title} />
  <Typography set:text={categoryEntry.data.shortDescription} />

  {
    subCategoryEntries.length > 0 && (
      <div class="flex gap-3 flex-wrap">
        {subCategoryEntries.map((c) => (
          <ButtonLink
            to={populationSlug ? `/${c.data.slug}/${populationSlug}` : c.data.slug}
            label={c.data.title}
            colorVariant={colorVariant === "neutral" ? "secondary" : colorVariant}
          />
        ))}
      </div>
    )
  }

  <CategoryResourceTypesSummary
    colorVariant={colorVariant === "neutral" ? "warmNeutral" : colorVariant}
    categorySlug={categoryEntry.data.slug}
    resourceTypesData={resourceTypeCounts}
    populationSlug={populationSlug}
  />

  <Link to={populationSlug ? `/${categoryEntry.data.slug}/${populationSlug}` : `/${categoryEntry.data.slug}`}>
    {"Explore "}<strong>{categoryEntry.data.title}</strong>
  </Link>
</Stack>
