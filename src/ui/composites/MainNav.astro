---
import LayoutSurface from "@ui/primitives/LayoutSurface.astro";
import Icon from "@ui/primitives/Icon.astro";
import Button from "@ui/primitives/Button.astro";
import Typography from "@ui/primitives/Typography.astro";
import { getCollection } from "astro:content";
import Link from "@ui/primitives/Link.astro";
import Stack from "@ui/primitives/Stack.astro";

// Type definitions
interface NavItem {
  id: string;
  label: string;
  href?: string;
  children?: NavItem[];
}

// Mock navigation data (3 tiers)
const navData: NavItem[] = [
  {
    id: "topics",
    label: "Topics",
    children: [
      {
        id: "understanding-grief",
        label: "Understanding Grief",
        children: [
          {
            id: "what-is-grief",
            label: "What is Grief?",
            href: "/topics/understanding-grief/what-is-grief",
          },
          {
            id: "stages-of-grief",
            label: "Stages of Grief",
            href: "/topics/understanding-grief/stages",
          },
          {
            id: "grief-vs-depression",
            label: "Grief vs Depression",
            href: "/topics/understanding-grief/grief-vs-depression",
          },
          {
            id: "physical-symptoms",
            label: "Physical Symptoms",
            href: "/topics/understanding-grief/physical-symptoms",
          },
        ],
      },
      {
        id: "for-the-newly-bereaved",
        label: "For The Newly Bereaved",
        children: [
          {
            id: "immediately-following",
            label: "Immediately Following the Death",
            href: "/topics/newly-bereaved/immediately-following",
          },
          {
            id: "early-days",
            label: "Tips for Early Days and Months",
            href: "/topics/newly-bereaved/early-days",
          },
          {
            id: "handling-estate",
            label: "Handling the Estate, Belongings and Financial Issues",
            href: "/topics/newly-bereaved/handling-estate",
          },
        ],
      },
      {
        id: "building-resilience",
        label: "Building Resilience",
        children: [
          {
            id: "finding-strength",
            label: "Finding Strength",
            href: "/topics/resilience/finding-strength",
          },
          {
            id: "creating-routines",
            label: "Creating Routines",
            href: "/topics/resilience/creating-routines",
          },
          {
            id: "growth-after-loss",
            label: "Growth After Loss",
            href: "/topics/resilience/growth",
          },
        ],
      },
      {
        id: "self-care",
        label: "Self Care",
        children: [
          {
            id: "physical-self-care",
            label: "Physical Self Care",
            href: "/topics/self-care/physical",
          },
          {
            id: "emotional-self-care",
            label: "Emotional Self Care",
            href: "/topics/self-care/emotional",
          },
          {
            id: "social-self-care",
            label: "Social Self Care",
            href: "/topics/self-care/social",
          },
        ],
      },
      {
        id: "therapy",
        label: "Therapy",
        children: [
          {
            id: "finding-therapist",
            label: "Finding a Therapist",
            href: "/topics/therapy/finding",
          },
          {
            id: "types-of-therapy",
            label: "Types of Therapy",
            href: "/topics/therapy/types",
          },
          {
            id: "group-therapy",
            label: "Group Therapy",
            href: "/topics/therapy/group",
          },
        ],
      },
      {
        id: "preparing-for-death",
        label: "Preparing For Death",
        children: [
          {
            id: "anticipatory-grief",
            label: "Anticipatory Grief",
            href: "/topics/preparing/anticipatory",
          },
          {
            id: "end-of-life-planning",
            label: "End of Life Planning",
            href: "/topics/preparing/planning",
          },
          {
            id: "being-present",
            label: "Being Present",
            href: "/topics/preparing/being-present",
          },
        ],
      },
      {
        id: "rarely-discussed",
        label: "Rarely Discussed",
        children: [
          {
            id: "complicated-grief",
            label: "Complicated Grief",
            href: "/topics/rarely-discussed/complicated",
          },
          {
            id: "disenfranchised-grief",
            label: "Disenfranchised Grief",
            href: "/topics/rarely-discussed/disenfranchised",
          },
          {
            id: "ambiguous-loss",
            label: "Ambiguous Loss",
            href: "/topics/rarely-discussed/ambiguous",
          },
        ],
      },
    ],
  },
  {
    id: "types-of-loss",
    label: "Types Of Loss",
    children: [
      {
        id: "death-of-spouse",
        label: "Death of a Spouse",
        children: [
          {
            id: "widowhood",
            label: "Widowhood",
            href: "/loss/spouse/widowhood",
          },
          {
            id: "young-widows",
            label: "Young Widows & Widowers",
            href: "/loss/spouse/young",
          },
          {
            id: "dating-after-loss",
            label: "Dating After Loss",
            href: "/loss/spouse/dating",
          },
        ],
      },
      {
        id: "death-of-parent",
        label: "Death of a Parent",
        children: [
          {
            id: "adult-orphans",
            label: "Adult Orphans",
            href: "/loss/parent/adult-orphans",
          },
          {
            id: "losing-last-parent",
            label: "Losing Your Last Parent",
            href: "/loss/parent/last-parent",
          },
          {
            id: "estranged-parent",
            label: "Estranged Parent",
            href: "/loss/parent/estranged",
          },
        ],
      },
      {
        id: "death-of-child",
        label: "Death of a Child",
        children: [
          {
            id: "infant-loss",
            label: "Infant Loss",
            href: "/loss/child/infant",
          },
          {
            id: "loss-of-adult-child",
            label: "Loss of Adult Child",
            href: "/loss/child/adult",
          },
          {
            id: "bereaved-parents",
            label: "Bereaved Parents",
            href: "/loss/child/bereaved-parents",
          },
        ],
      },
      {
        id: "death-of-sibling",
        label: "Death of a Sibling",
        children: [
          {
            id: "sibling-bond",
            label: "The Sibling Bond",
            href: "/loss/sibling/bond",
          },
          {
            id: "surviving-siblings",
            label: "Surviving Siblings",
            href: "/loss/sibling/surviving",
          },
        ],
      },
      {
        id: "pet-loss",
        label: "Pet Loss",
        children: [
          {
            id: "grieving-pet",
            label: "Grieving a Pet",
            href: "/loss/pet/grieving",
          },
          {
            id: "pet-euthanasia",
            label: "Pet Euthanasia",
            href: "/loss/pet/euthanasia",
          },
          {
            id: "children-pet-loss",
            label: "Children and Pet Loss",
            href: "/loss/pet/children",
          },
        ],
      },
      {
        id: "pregnancy-loss",
        label: "Pregnancy Loss",
        children: [
          {
            id: "miscarriage",
            label: "Miscarriage",
            href: "/loss/pregnancy/miscarriage",
          },
          {
            id: "stillbirth",
            label: "Stillbirth",
            href: "/loss/pregnancy/stillbirth",
          },
          {
            id: "infertility-grief",
            label: "Infertility Grief",
            href: "/loss/pregnancy/infertility",
          },
        ],
      },
      {
        id: "suicide-loss",
        label: "Suicide Loss",
        children: [
          {
            id: "suicide-survivors",
            label: "Suicide Survivors",
            href: "/loss/suicide/survivors",
          },
          {
            id: "stigma",
            label: "Dealing with Stigma",
            href: "/loss/suicide/stigma",
          },
          {
            id: "complicated-emotions",
            label: "Complicated Emotions",
            href: "/loss/suicide/emotions",
          },
        ],
      },
    ],
  },
  {
    id: "supporting-the-bereaved",
    label: "Supporting the Bereaved",
    children: [
      {
        id: "what-to-say",
        label: "What to Say",
        children: [
          {
            id: "helpful-phrases",
            label: "Helpful Phrases",
            href: "/support/what-to-say/helpful",
          },
          {
            id: "acknowledging-loss",
            label: "Acknowledging Loss",
            href: "/support/what-to-say/acknowledging",
          },
        ],
      },
      {
        id: "what-not-to-say",
        label: "What Not to Say",
        children: [
          {
            id: "harmful-phrases",
            label: "Harmful Phrases",
            href: "/support/what-not-to-say/harmful",
          },
          {
            id: "toxic-positivity",
            label: "Toxic Positivity",
            href: "/support/what-not-to-say/toxic-positivity",
          },
        ],
      },
      {
        id: "practical-help",
        label: "Practical Help",
        children: [
          {
            id: "meal-trains",
            label: "Meal Trains",
            href: "/support/practical/meals",
          },
          {
            id: "errands",
            label: "Running Errands",
            href: "/support/practical/errands",
          },
          {
            id: "childcare",
            label: "Childcare",
            href: "/support/practical/childcare",
          },
        ],
      },
      {
        id: "long-term-support",
        label: "Long-term Support",
        children: [
          {
            id: "checking-in",
            label: "Checking In",
            href: "/support/long-term/checking-in",
          },
          {
            id: "anniversaries",
            label: "Anniversaries",
            href: "/support/long-term/anniversaries",
          },
          {
            id: "ongoing-presence",
            label: "Ongoing Presence",
            href: "/support/long-term/presence",
          },
        ],
      },
      {
        id: "supporting-children",
        label: "Supporting Children",
        children: [
          {
            id: "talking-to-kids",
            label: "Talking to Kids",
            href: "/support/children/talking",
          },
          {
            id: "age-appropriate",
            label: "Age-Appropriate Support",
            href: "/support/children/age-appropriate",
          },
        ],
      },
    ],
  },
  {
    id: "finding-support",
    label: "Finding Support",
    children: [
      {
        id: "support-groups",
        label: "Support Groups",
        children: [
          {
            id: "local-groups",
            label: "Local Groups",
            href: "/finding-support/groups/local",
          },
          {
            id: "online-groups",
            label: "Online Groups",
            href: "/finding-support/groups/online",
          },
        ],
      },
      {
        id: "therapy-counseling",
        label: "Therapy & Counseling",
        children: [
          {
            id: "grief-counselors",
            label: "Grief Counselors",
            href: "/finding-support/therapy/counselors",
          },
          {
            id: "online-therapy",
            label: "Online Therapy",
            href: "/finding-support/therapy/online",
          },
        ],
      },
      {
        id: "crisis-resources",
        label: "Crisis Resources",
        children: [
          {
            id: "hotlines",
            label: "Hotlines",
            href: "/finding-support/crisis/hotlines",
          },
          {
            id: "emergency",
            label: "Emergency Resources",
            href: "/finding-support/crisis/emergency",
          },
        ],
      },
      {
        id: "books-reading",
        label: "Books & Reading",
        children: [
          {
            id: "grief-books",
            label: "Grief Books",
            href: "/finding-support/books/grief",
          },
          {
            id: "memoirs",
            label: "Memoirs",
            href: "/finding-support/books/memoirs",
          },
        ],
      },
      {
        id: "podcasts-media",
        label: "Podcasts & Media",
        children: [
          {
            id: "grief-podcasts",
            label: "Grief Podcasts",
            href: "/finding-support/media/podcasts",
          },
          {
            id: "videos",
            label: "Videos",
            href: "/finding-support/media/videos",
          },
        ],
      },
    ],
  },
  {
    id: "underserved-groups",
    label: "Underserved Groups",
    children: [
      {
        id: "lgbtq",
        label: "LGBTQ+",
        children: [
          {
            id: "lgbtq-grief",
            label: "LGBTQ+ Grief",
            href: "/underserved/lgbtq/grief",
          },
          {
            id: "chosen-family",
            label: "Chosen Family Loss",
            href: "/underserved/lgbtq/chosen-family",
          },
        ],
      },
      {
        id: "bipoc",
        label: "BIPOC Communities",
        children: [
          {
            id: "cultural-grief",
            label: "Cultural Grief Practices",
            href: "/underserved/bipoc/cultural",
          },
          {
            id: "racial-trauma",
            label: "Racial Trauma & Grief",
            href: "/underserved/bipoc/racial-trauma",
          },
        ],
      },
      {
        id: "veterans",
        label: "Veterans & Military",
        children: [
          {
            id: "military-loss",
            label: "Military Loss",
            href: "/underserved/veterans/military-loss",
          },
          {
            id: "ptsd-grief",
            label: "PTSD and Grief",
            href: "/underserved/veterans/ptsd",
          },
        ],
      },
      {
        id: "first-responders",
        label: "First Responders",
        children: [
          {
            id: "line-of-duty",
            label: "Line of Duty Deaths",
            href: "/underserved/first-responders/line-of-duty",
          },
          {
            id: "cumulative-grief",
            label: "Cumulative Grief",
            href: "/underserved/first-responders/cumulative",
          },
        ],
      },
      {
        id: "immigrants-refugees",
        label: "Immigrants & Refugees",
        children: [
          {
            id: "displacement-grief",
            label: "Displacement Grief",
            href: "/underserved/immigrants/displacement",
          },
          {
            id: "cultural-barriers",
            label: "Cultural Barriers",
            href: "/underserved/immigrants/barriers",
          },
        ],
      },
    ],
  },
];

const categories = await getCollection("categories");
if ((categories ?? []).length === 0) {
  throw new Error("Could not get categories in [MainNav]");
}

const tier1Items = [
  categories.find((x) => x.data.slug === "topics"),
  categories.find((x) => x.data.slug === "types-of-loss"),
  categories.find((x) => x.data.slug === "supporting-the-bereaved"),
].filter((x) => x !== undefined);
---

<main-nav-controller>
  <LayoutSurface variant="primaryContrast" variantKey={2}>
    <div class="flex justify-end p-2 md:hidden">
      <!-- Mobile hamburger trigger -->
      <button
        data-mobile-trigger
        aria-expanded="false"
        aria-label="Open navigation menu"
        aria-controls="mobile-menu"
        type="button"
        class:list={["bg-contentSurface-primaryContrast--prominent"]}
      >
        <span class="flex items-center gap-1">
          <Typography
            as="span"
            variant="button-1"
            color="primaryContrast"
            set:text="Menu"
          />
          <Icon
            display="inline"
            getIcon={(icons) => icons.barsThree}
            color="primaryContrast"
            size={3}
          />
        </span>
      </button>
    </div>

    <!-- Desktop horizontal nav -->
    <nav
      class="hidden md:flex md:items-center md:justify-between md:gap-1 md:max-w-6xl md:mx-auto"
      data-desktop-nav
      aria-label="Main navigation"
    >
      {
        tier1Items.map((item) => (
          <button
            type="button"
            data-tier1-btn={item.id}
            class:list={[
              "px-4 py-2",
              "cursor-pointer",
              "transition duration-300",
              "font-sans-a font-medium",
              "text-onSurface-primaryContrast--default",
              "bg-contentSurface-primaryContrast--prominent hover:bg-contentSurface-primaryContrast--default",
              "data-active:bg-contentSurface-primary--default data-active:text-onSurface-primary--default",
            ]}
            aria-expanded="false"
            aria-haspopup="true"
          >
            {item.data.title}
          </button>
        ))
      }
    </nav>
  </LayoutSurface>

  <!-- Mobile overlay -->
  <div
    id="mobile-menu"
    data-mobile-menu
    hidden
    class="fixed inset-0 z-50 md:hidden"
  >
    <!-- Tier 1 Panel -->
    <div data-tier1-panel class="absolute inset-0 bg-white flex flex-col">
      <div class="flex justify-end p-4">
        <Button
          data-mobile-close
          type="button"
          styleVariant="outlined"
          colorVariant="neutral"
          textVariant="button-1"
          label="Close"
        />
      </div>
      <nav class="p-12 space-y-4">
        {
          navData.map((item) => (
            <button
              type="button"
              data-mobile-tier1-btn={item.id}
              class:list={[
                "transition duration-300",
                "w-full",
                "cursor-pointer",
                "font-serif text-xl text-left",
                "text-onSurface-primary--default hover:text-onSurface-primary--muted",
              ]}
            >
              {item.label}
            </button>
          ))
        }
      </nav>
    </div>

    <!-- Tier 2 Panel (slides from right) -->
    <div
      data-tier2-panel
      class="absolute inset-0 bg-white flex flex-col translate-x-full transition-transform duration-300 ease-in-out"
    >
      <header class="flex justify-between items-center p-4">
        <button
          type="button"
          data-mobile-back-to-tier1
          class="text-onSurface-coolNeutral--muted font-sans-a cursor-pointer hover:text-onSurface-coolNeutral--default transition-colors"
        >
          &larr; Back
        </button>
        <Button
          data-mobile-close
          type="button"
          styleVariant="outlined"
          colorVariant="neutral"
          textVariant="button-1"
          label="Close"
        />
      </header>
      <div class="flex-1 px-6 py-4">
        {
          navData.map((tier1) => (
            <div data-tier2-section={tier1.id} hidden>
              <h2 class="font-serif font-bold text-2xl text-onSurface-primary--default mb-6">
                {tier1.label}
              </h2>
              <nav>
                <ul class="space-y-4">
                  {tier1.children?.map((tier2) => (
                    <li>
                      <button
                        type="button"
                        data-mobile-tier2-btn={tier2.id}
                        data-parent-tier1={tier1.id}
                        class="text-onSurface-primary--default font-serif text-lg cursor-pointer hover:text-onSurface-primary--muted transition-colors text-left w-full"
                      >
                        {tier2.label}
                      </button>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Tier 3 Panel (slides from right) -->
    <div
      data-tier3-panel
      class="absolute inset-0 bg-white flex flex-col translate-x-full transition-transform duration-300 ease-in-out"
    >
      <header class="flex justify-between items-center p-4">
        <button
          type="button"
          data-mobile-back-to-tier2
          class="text-onSurface-coolNeutral--muted font-sans-a cursor-pointer hover:text-onSurface-coolNeutral--default transition-colors"
        >
          &larr; Back
        </button>
        <Button
          data-mobile-close
          type="button"
          styleVariant="outlined"
          colorVariant="neutral"
          textVariant="button-1"
          label="Close"
        />
      </header>
      <div class="flex-1 px-6 py-4">
        {
          navData.flatMap((tier1) =>
            tier1.children?.map((tier2) => (
              <div data-tier3-section={tier2.id} hidden>
                <h2 class="font-serif font-bold text-2xl text-onSurface-primary--default mb-6">
                  {tier2.label}
                </h2>
                <nav>
                  <ul class="space-y-4">
                    {tier2.children?.map((tier3) => (
                      <li>
                        <a
                          href={tier3.href || "#"}
                          class="text-onSurface-primary--default font-serif text-lg hover:text-onSurface-primary--muted transition-colors block"
                        >
                          {tier3.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            )),
          )
        }
      </div>
    </div>
  </div>

  <!-- Desktop mega-nav -->
  <div
    data-mega-nav
    hidden
    class="shadow-lg border-t"
    class:list={[
      "hidden md:block",
      "absolute left-0 right-0 z-40",
      "max-w-7xl mx-auto",
      "bg-contentSurface-primary--default",
    ]}
  >
    <div class="grid grid-cols-[280px_1fr]">
      <!-- Left pane: Tier 2 items -->
      <div data-mega-tier2-pane class="py-12">
        {
          tier1Items.map((tier1Item) => (
            <ul data-mega-tier2-list={tier1Item.id} hidden>
              {tier1Item.data.subcategories.map(({ id }, i) => {
                const c = categories.find((x) => x.id === id);

                if (!c) return;

                return (
                  <li>
                    <button
                      type="button"
                      data-mega-tier2-btn={c.data.id}
                      data-parent-tier1={c.data.id}
                      data-first={i === 0 ? "" : undefined}
                      class="w-full text-left px-4 py-2 font-serif text-onSurface-primary--default cursor-pointer hover:bg-layoutSurface-primary--1 transition-colors border-l-4 border-transparent data-[active]:border-line-brand--accent data-[active]:bg-layoutSurface-neutral--1"
                    >
                      {c.data.title}
                    </button>
                  </li>
                );
              })}
            </ul>
          ))
        }
      </div>

      <!-- Right pane: Tier 3 items -->
      <div data-mega-tier3-pane class="py-4 px-6 bg-layoutSurface-neutral--1">
        <div class="flex justify-end mb-4">
          <Button
            data-mega-close
            type="button"
            styleVariant="outlined"
            colorVariant="neutral"
            textVariant="button-1"
            label="Close"
          />
        </div>
        {
          tier1Items.flatMap(({ data: tier1Item }) =>
            tier1Item.subcategories.map(({ id }) => {
              const tier2Item = categories.find((x) => x.id === id);
              if (!tier2Item) {
                return;
              }

              return (
                <div data-mega-tier3-section={tier2Item.id} hidden>
                  <h3 class="font-serif font-bold text-2xl text-onSurface-primary--default mb-4">
                    {tier2Item.data.title}
                  </h3>
                  <ul class="space-y-3">
                    {tier2Item.data.subcategories.map(({ id }) => {
                      const tier3Item = categories.find((x) => x.id === id);
                      if (!tier3Item) {
                        return;
                      }

                      return (
                        <li>
                          <Link
                            bold
                            to={`/${tier3Item.data.slug}` || "#"}
                            label={tier3Item.data.title}
                            variant="body-2"
                          />

                          {tier3Item.data.subcategories.length > 0 && (
                            <Stack>
                              {tier3Item.data.subcategories.map(({ id }) => {
                                const tier4Item = categories.find(
                                  (x) => x.id === id,
                                );
                                if (!tier4Item) {
                                  return;
                                }

                                return (
                                  <div>
                                    <Link
                                      to={`/${tier4Item.data.slug}`}
                                      label={tier4Item.data.title}
                                    />
                                  </div>
                                );
                              })}
                            </Stack>
                          )}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              );
            }),
          )
        }
      </div>
    </div>
  </div>
</main-nav-controller>

<script is:inline>
  class MainNavController extends HTMLElement {
    // State
    selectedTier1Id = null;
    selectedTier2Id = null;

    connectedCallback() {
      this.setupMobileHandlers();
      this.setupDesktopHandlers();
      this.setupKeyboardHandlers();
    }

    // ========== Mobile Handlers ==========

    setupMobileHandlers() {
      // Open mobile menu
      const mobileTrigger = this.querySelector("[data-mobile-trigger]");
      mobileTrigger?.addEventListener("click", () => this.openMobileMenu());

      // Close buttons
      this.querySelectorAll("[data-mobile-close]").forEach((btn) => {
        btn.addEventListener("click", () => this.closeMobileMenu());
      });

      // Tier 1 buttons -> show tier 2
      this.querySelectorAll("[data-mobile-tier1-btn]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tier1Id = btn.getAttribute("data-mobile-tier1-btn");
          this.showMobileTier2(tier1Id);
        });
      });

      // Tier 2 buttons -> show tier 3
      this.querySelectorAll("[data-mobile-tier2-btn]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tier2Id = btn.getAttribute("data-mobile-tier2-btn");
          this.showMobileTier3(tier2Id);
        });
      });

      // Back to tier 1
      const backToTier1 = this.querySelector("[data-mobile-back-to-tier1]");
      backToTier1?.addEventListener("click", () => this.hideMobileTier2());

      // Back to tier 2
      const backToTier2 = this.querySelector("[data-mobile-back-to-tier2]");
      backToTier2?.addEventListener("click", () => this.hideMobileTier3());
    }

    openMobileMenu() {
      const menu = this.querySelector("[data-mobile-menu]");
      const trigger = this.querySelector("[data-mobile-trigger]");
      menu?.removeAttribute("hidden");
      trigger?.setAttribute("aria-expanded", "true");
      document.body.style.overflow = "hidden";
    }

    closeMobileMenu() {
      const menu = this.querySelector("[data-mobile-menu]");
      const trigger = this.querySelector("[data-mobile-trigger]");
      const tier2Panel = this.querySelector("[data-tier2-panel]");
      const tier3Panel = this.querySelector("[data-tier3-panel]");

      menu?.setAttribute("hidden", "");
      trigger?.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";

      // Reset panels
      tier2Panel?.classList.add("translate-x-full");
      tier3Panel?.classList.add("translate-x-full");

      // Hide all sections
      this.querySelectorAll("[data-tier2-section]").forEach((section) => {
        section.hidden = true;
      });
      this.querySelectorAll("[data-tier3-section]").forEach((section) => {
        section.hidden = true;
      });

      this.selectedTier1Id = null;
      this.selectedTier2Id = null;
    }

    showMobileTier2(tier1Id) {
      this.selectedTier1Id = tier1Id;

      // Hide all tier 2 sections, show the selected one
      this.querySelectorAll("[data-tier2-section]").forEach((section) => {
        section.hidden = section.dataset.tier2Section !== tier1Id;
      });

      // Slide in tier 2 panel
      const panel = this.querySelector("[data-tier2-panel]");
      panel?.classList.remove("translate-x-full");
    }

    hideMobileTier2() {
      const panel = this.querySelector("[data-tier2-panel]");
      panel?.classList.add("translate-x-full");
      this.selectedTier1Id = null;
    }

    showMobileTier3(tier2Id) {
      this.selectedTier2Id = tier2Id;

      // Hide all tier 3 sections, show the selected one
      this.querySelectorAll("[data-tier3-section]").forEach((section) => {
        section.hidden = section.dataset.tier3Section !== tier2Id;
      });

      // Slide in tier 3 panel
      const panel = this.querySelector("[data-tier3-panel]");
      panel?.classList.remove("translate-x-full");
    }

    hideMobileTier3() {
      const panel = this.querySelector("[data-tier3-panel]");
      panel?.classList.add("translate-x-full");
      this.selectedTier2Id = null;
    }

    // ========== Desktop Handlers ==========

    setupDesktopHandlers() {
      // Tier 1 buttons
      this.querySelectorAll("[data-tier1-btn]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tier1Id = btn.getAttribute("data-tier1-btn");
          if (this.selectedTier1Id === tier1Id) {
            this.closeMegaNav();
          } else {
            this.openMegaNav(tier1Id);
          }
        });
      });

      // Tier 2 buttons in mega nav
      this.querySelectorAll("[data-mega-tier2-btn]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tier2Id = btn.getAttribute("data-mega-tier2-btn");
          this.selectMegaTier2(tier2Id);
        });
      });

      // Close button
      const closeBtn = this.querySelector("[data-mega-close]");
      closeBtn?.addEventListener("click", () => this.closeMegaNav());

      // Click outside to close
      document.addEventListener("click", (e) => {
        const megaNav = this.querySelector("[data-mega-nav]");
        if (megaNav && !megaNav.hasAttribute("hidden")) {
          const isInsideNav = this.contains(e.target);
          if (!isInsideNav) {
            this.closeMegaNav();
          }
        }
      });
    }

    openMegaNav(tier1Id) {
      this.selectedTier1Id = tier1Id;

      // Update active state on tier 1 buttons
      this.querySelectorAll("[data-tier1-btn]").forEach((btn) => {
        const btnId = btn.getAttribute("data-tier1-btn");
        if (btnId === tier1Id) {
          btn.setAttribute("data-active", "");
          btn.setAttribute("aria-expanded", "true");
        } else {
          btn.removeAttribute("data-active");
          btn.setAttribute("aria-expanded", "false");
        }
      });

      // Hide all tier 2 lists, show the selected one
      this.querySelectorAll("[data-mega-tier2-list]").forEach((list) => {
        list.hidden = list.dataset.megaTier2List !== tier1Id;
      });

      // Select first tier 2 item by default
      const firstTier2Btn = this.querySelector(
        `[data-mega-tier2-list="${tier1Id}"] [data-first]`,
      );
      if (firstTier2Btn) {
        const firstTier2Id = firstTier2Btn.getAttribute("data-mega-tier2-btn");
        this.selectMegaTier2(firstTier2Id);
      }

      // Show mega nav
      const megaNav = this.querySelector("[data-mega-nav]");
      megaNav?.removeAttribute("hidden");
    }

    closeMegaNav() {
      const megaNav = this.querySelector("[data-mega-nav]");
      megaNav?.setAttribute("hidden", "");

      // Reset tier 1 button states
      this.querySelectorAll("[data-tier1-btn]").forEach((btn) => {
        btn.removeAttribute("data-active");
        btn.setAttribute("aria-expanded", "false");
      });

      // Hide all tier 2 lists
      this.querySelectorAll("[data-mega-tier2-list]").forEach((list) => {
        list.hidden = true;
      });

      // Hide all tier 3 sections
      this.querySelectorAll("[data-mega-tier3-section]").forEach((section) => {
        section.hidden = true;
      });

      // Reset tier 2 button active states
      this.querySelectorAll("[data-mega-tier2-btn]").forEach((btn) => {
        btn.removeAttribute("data-active");
      });

      this.selectedTier1Id = null;
      this.selectedTier2Id = null;
    }

    selectMegaTier2(tier2Id) {
      this.selectedTier2Id = tier2Id;

      // Update active state on tier 2 buttons (only in the visible list)
      this.querySelectorAll("[data-mega-tier2-btn]").forEach((btn) => {
        const btnId = btn.getAttribute("data-mega-tier2-btn");
        if (btnId === tier2Id) {
          btn.setAttribute("data-active", "");
        } else {
          btn.removeAttribute("data-active");
        }
      });

      // Hide all tier 3 sections, show the selected one
      this.querySelectorAll("[data-mega-tier3-section]").forEach((section) => {
        section.hidden = section.dataset.megaTier3Section !== tier2Id;
      });
    }

    // ========== Keyboard Handlers ==========

    setupKeyboardHandlers() {
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const mobileMenu = this.querySelector("[data-mobile-menu]");
          const megaNav = this.querySelector("[data-mega-nav]");

          if (mobileMenu && !mobileMenu.hasAttribute("hidden")) {
            this.closeMobileMenu();
          } else if (megaNav && !megaNav.hasAttribute("hidden")) {
            this.closeMegaNav();
          }
        }
      });
    }
  }

  customElements.define("main-nav-controller", MainNavController);
</script>
