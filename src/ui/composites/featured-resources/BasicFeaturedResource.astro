---
import { getEntry, type ReferenceDataEntry } from "astro:content";

import type { BasicInternetResourceCollectionKey } from "@content/collections";

import {
  getSourceFromResourceUrl,
  getSourceLinkFromWebsiteRef,
} from "@ui/utils/helpers";
import Card from "@ui/composites/Card.astro";
import ResourceSource from "../ResourceSource.astro";
import Typography from "@ui/primitives/Typography.astro";

interface Props {
  resourceRef: ReferenceDataEntry<BasicInternetResourceCollectionKey, string>;
}

const props = Astro.props;

const { data } = await getEntry(props.resourceRef);
if (!data) {
  throw new Error(
    `[BasicFeaturedResource] could not get resource from reference: ${props.resourceRef.id}`,
  );
}

const source = data.sourceWebsiteId
  ? await getSourceLinkFromWebsiteRef(data.sourceWebsiteId)
  : null;

const safeSource = source ?? getSourceFromResourceUrl(data.resourceUrl);

const image = data.image ? { image: data.image.image, altText: "" } : null;
---

<Card image={image} title={data.title} titleHref={data.resourceUrl} external>
  {safeSource && <ResourceSource source={safeSource} />}
  {data.description && <Typography>{data.description}</Typography>}
</Card>
