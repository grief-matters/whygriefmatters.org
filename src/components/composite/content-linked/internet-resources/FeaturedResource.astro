---
import { getEntry, type ReferenceDataEntry } from "astro:content";

import type { BasicInternetResourceCollectionKey } from "@content/collections";

import {
  getSourceLinkFromWebsiteRef,
  getSourceFromResourceUrl,
} from "@ui/utils/content/content";

import Typography from "@ui/base/Typography.astro";
import Card from "@ui/composite/Card.astro";
import ResourceSource from "./ResourceSource.astro";

interface Props {
  resourceRef: ReferenceDataEntry<BasicInternetResourceCollectionKey, string>;
  fullHeight?: boolean;
}

const { resourceRef, fullHeight } = Astro.props;

const { data } = await getEntry(resourceRef);
if (!data) {
  throw new Error(
    `[BasicFeaturedResource] could not get resource from reference: ${resourceRef.id}`,
  );
}

const source = data.sourceWebsiteId
  ? await getSourceLinkFromWebsiteRef(data.sourceWebsiteId)
  : null;

const safeSource = source ?? getSourceFromResourceUrl(data.resourceUrl);

const image = data.image ? { image: data.image.image, altText: "" } : null;
---

<Card
  external
  fullHeight={fullHeight}
  image={image}
  title={data.title}
  titleHref={data.resourceUrl}
>
  {safeSource && <ResourceSource source={safeSource} />}
  {data.description && <Typography>{data.description}</Typography>}
</Card>
