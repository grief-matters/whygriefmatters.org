---
import { getCollection, getEntry } from "astro:content";

import { buildCategoryTree } from "@ui/utils/content/category";
import { pruneTreeForPopulation } from "@ui/utils/content/population";
import { buildResourceExistenceSet } from "@ui/utils/content/shared";
import { makeLabelPartsForPopulationResources } from "@ui/utils/content/content";

import PageHeaderLayout from "@ui/layouts/PageHeaderLayout.astro";
import SitePageLayout from "@ui/layouts/SitePageLayout.astro";

import Typography from "@ui/base/Typography.astro";

import ExploreLinks from "@ui/composite/ExploreLinks.astro";
import Section from "@ui/layouts/Section.astro";
import Stack from "@ui/base/Stack.astro";

import CategorySummaryList from "../category/CategorySummaryList.astro";
import PopulationHeaderBar from "../population/PopulationHeaderBar.astro";
import ContentBlockRenderer from "../content-block/ContentBlockRenderer.astro";

interface Props {
  categoryId: string;
  populationId: string;
  leadInContentBlockRefs?: Array<string>;
}

const { categoryId, populationId, leadInContentBlockRefs } = Astro.props;

const categories = await getCollection("categories");

const root = categories.find((x) => x.id === categoryId);
if (!root) {
  throw new Error(
    `Could not find [categoryEntry] for id: [${categoryId}] in [PopulationRootCategoryPage]`,
  );
}

const populationEntry = await getEntry("populations", populationId);
if (!populationEntry) {
  throw new Error(
    `Could not find [populationEntry] for id: [${populationId}] in [PopulationRootCategoryPage]`,
  );
}

// Build category tree and prune for this population
const existenceSet = await buildResourceExistenceSet();
const fullTree = buildCategoryTree(root, categories);
const prunedTree = pruneTreeForPopulation(
  fullTree,
  populationId,
  populationEntry.data.slug,
  existenceSet,
);

// Get surviving subcategory IDs from the pruned tree
const survivingSubcategoryIds = new Set(
  prunedTree?.children.map((child) => child.id) ?? [],
);

// Filter root subcategories to only those that survived pruning
const filteredSubcategoryRefs = root.data.subcategories.filter((ref) =>
  survivingSubcategoryIds.has(ref.id),
);

// Resolve filtered subcategory entries for the header links
const filteredSubcategoryEntries = filteredSubcategoryRefs
  .map((ref) => categories.find((c) => c.id === ref.id))
  .filter((c): c is (typeof categories)[number] => c !== undefined);

// Generate population label
const labelParts = await makeLabelPartsForPopulationResources(populationId);
---

<SitePageLayout>
  <PageHeaderLayout
    surfaceVariant="primaryContrast"
    surfaceVariantKey={1}
    image={populationEntry.data.image}
  >
    <Typography
      marginBottom={2}
      as="h1"
      variant="title-1"
      colorVariant="primaryContrast"
    >
      {root.data.displayTitle ?? root.data.title}
    </Typography>
    {
      root.data.shortDescription && (
        <Typography
          as="p"
          variant="body-2"
          colorVariant="primaryContrast"
          marginBottom={2}
        >
          {root.data.shortDescription}
        </Typography>
      )
    }
    {
      filteredSubcategoryEntries.length > 0 && (
        <ExploreLinks
          links={filteredSubcategoryEntries.map((c) => ({
            url: `/${c.data.slug}/${populationEntry.data.slug}`,
            label: c.data.title,
          }))}
        />
      )
    }
    <PopulationHeaderBar
      slot="footer"
      labelParts={labelParts}
      allResourcesHref={`/${root.data.slug}`}
    />
  </PageHeaderLayout>
  {
    leadInContentBlockRefs && (
      <Section colorVariant="neutral">
        <Stack>
          {leadInContentBlockRefs.map((blockId) => (
            <ContentBlockRenderer
              contentBlockRef={{
                collection: "contentBlocks",
                id: blockId,
              }}
            />
          ))}
        </Stack>
      </Section>
    )
  }
  <CategorySummaryList
    categoryRefs={filteredSubcategoryRefs}
    colorVariant="tertiary"
    populationId={populationId}
    populationSlug={populationEntry.data.slug}
  />
</SitePageLayout>
