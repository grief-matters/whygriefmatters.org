---
import type {
  InternetResourceCollectionKey,
  InternetResourceEntries,
} from "@content/collections";

import Stack from "@ui/base/Stack.astro";
import Container from "@ui/base/Container.astro";
import Button from "@ui/base/Button.astro";
import ResourceListingRenderer from "@ui/composite/content-linked/internet-resources/ResourceListingRenderer.astro";

import { paddingSettingMap, marginBottomMap } from "@styles/utils/spacing";

import JumpLinks from "./JumpLinks.astro";
import ResourcesFilterPanel from "./ResourcesFilterPanel.astro";

interface Props {
  resourceTypes: Array<InternetResourceCollectionKey>;
  internetResources: InternetResourceEntries;
}

const { resourceTypes, internetResources } = Astro.props;
---

<resource-filter-controller>
  <!-- Main content column -->
  <Stack spacing={5}>
    <Container>
      <ResourcesFilterPanel resourceTypes={resourceTypes} />
    </Container>
    <div
      class:list={[
        "md:grid md:grid-cols-[1fr_auto] md:gap-6 lg:gap-12 lg:grid-cols-[1fr_auto_minmax(150px,1fr)]",
      ]}
    >
      <!-- Desktop Jump To Nav (sticky sidebar) -->
      <nav class="hidden md:block md:order-last" data-jump-nav>
        <div class="md:sticky md:top-40 md:mt-12">
          <JumpLinks resourceTypes={resourceTypes} />
        </div>
      </nav>

      <!-- Mobile Jump To Button + Panel -->
      <div class="md:hidden fixed bottom-4 right-4 z-10" data-mobile-jump>
        <Button
          data-mobile-jump-btn
          label="Jump To"
          textVariant="button-2"
          colorVariant="neutral"
          styleVariant="outlined"
        />
        <div
          data-mobile-jump-panel
          hidden
          class:list={[paddingSettingMap[3], "bg-contentSurface-neutral--muted border border-line-neutral--default rounded-lg shadow-lg"]}
        >
          <div class:list={[marginBottomMap[2], "flex justify-between"]}>
            <JumpLinks resourceTypes={resourceTypes} />
            <button
              data-mobile-jump-close
              class="text-onSurface-coolNeutral--muted hover:text-onSurface-coolNeutral--default self-start"
            >
              âœ•
            </button>
          </div>
        </div>
      </div>
      <div class="hidden lg:block"></div>
      <Container>
        <ResourceListingRenderer internetResources={internetResources} />
      </Container>
    </div>
  </Stack>
</resource-filter-controller>

<script>
  class ResourceFilterController extends HTMLElement {
    private activeFilters: Set<string> = new Set();

    connectedCallback() {
      const filterBtns = this.querySelectorAll("[data-filter-btn]");
      const clearBtn = this.querySelector("[data-clear-filters]");

      filterBtns.forEach((btn) => {
        btn.addEventListener("click", () => this.toggleFilter(btn));
      });

      clearBtn?.addEventListener("click", () => this.clearFilters());

      // Jump link click handlers
      const jumpLinks = this.querySelectorAll("[data-jump-link]");
      jumpLinks.forEach((link) => {
        link.addEventListener("click", (e) => this.handleJumpClick(e, link));
      });

      // Back to top handlers
      const backToTopLinks = this.querySelectorAll("[data-back-to-top]");
      backToTopLinks.forEach((link) => {
        link.addEventListener("click", (e) => this.handleBackToTop(e));
      });

      // Mobile panel toggle
      const mobileBtn = this.querySelector("[data-mobile-jump-btn]");
      const mobileCloseBtn = this.querySelector("[data-mobile-jump-close]");

      mobileBtn?.addEventListener("click", () => this.toggleMobilePanel());
      mobileCloseBtn?.addEventListener("click", () => this.toggleMobilePanel());
    }

    toggleFilter(btn: Element) {
      const resourceType = btn.getAttribute("data-resource-type");
      if (!resourceType) return;

      if (this.activeFilters.has(resourceType)) {
        this.activeFilters.delete(resourceType);
        btn.removeAttribute("data-active");
      } else {
        this.activeFilters.add(resourceType);
        btn.setAttribute("data-active", "");
      }

      this.applyFilters();
    }

    clearFilters() {
      this.activeFilters.clear();
      this.querySelectorAll("[data-filter-btn][data-active]").forEach((btn) => {
        btn.removeAttribute("data-active");
      });
      this.applyFilters();
    }

    applyFilters() {
      const sections = this.querySelectorAll("[data-resource-section]");

      sections.forEach((section) => {
        const sectionType = section.getAttribute("data-resource-section");
        if (!sectionType) return;

        if (
          this.activeFilters.size === 0 ||
          this.activeFilters.has(sectionType)
        ) {
          section.removeAttribute("hidden");
        } else {
          section.setAttribute("hidden", "");
        }
      });

      this.updateJumpLinkStates();
    }

    handleJumpClick(e: Event, link: Element) {
      e.preventDefault();
      const resourceType = link.getAttribute("data-jump-link");
      if (!resourceType) return;

      const section = this.querySelector(`#${resourceType}`);

      // If section is hidden by filters, add it to active filters
      if (section?.hasAttribute("hidden")) {
        const btn = this.querySelector(
          `[data-filter-btn][data-resource-type="${resourceType}"]`,
        );
        if (btn && !this.activeFilters.has(resourceType)) {
          this.activeFilters.add(resourceType);
          btn.setAttribute("data-active", "");
          this.applyFilters();
        }
      }

      // Scroll to section and update URL hash
      section?.scrollIntoView({ behavior: "smooth" });
      history.pushState(null, "", `#${resourceType}`);

      // Close mobile panel if open
      const mobilePanel = this.querySelector("[data-mobile-jump-panel]");
      if (mobilePanel && !mobilePanel.hasAttribute("hidden")) {
        this.toggleMobilePanel();
      }
    }

    handleBackToTop(e: Event) {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: "smooth" });

      // Close mobile panel if open
      const mobilePanel = this.querySelector("[data-mobile-jump-panel]");
      if (mobilePanel && !mobilePanel.hasAttribute("hidden")) {
        this.toggleMobilePanel();
      }
    }

    toggleMobilePanel() {
      const panel = this.querySelector("[data-mobile-jump-panel]");
      const btn = this.querySelector("[data-mobile-jump-btn]");
      panel?.toggleAttribute("hidden");
      btn?.toggleAttribute("hidden");
    }

    updateJumpLinkStates() {
      const jumpLinks = this.querySelectorAll("[data-jump-link]");
      jumpLinks.forEach((link) => {
        const resourceType = link.getAttribute("data-jump-link");
        if (!resourceType) return;

        const section = this.querySelector(`#${resourceType}`);
        if (section?.hasAttribute("hidden")) {
          link.setAttribute("data-filtered", "");
        } else {
          link.removeAttribute("data-filtered");
        }
      });
    }
  }

  customElements.define("resource-filter-controller", ResourceFilterController);
</script>
